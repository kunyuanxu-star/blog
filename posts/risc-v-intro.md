---
title: RISC-V æ¶æ„åˆæ¢ï¼šæŒ‡ä»¤é›†ä¸å¯„å­˜å™¨
date: 2024-03-30
category: Arch
tags: [RISC-V, Assembly, Hardware]
---

# RISC-V æ¶æ„åˆæ¢ï¼šæŒ‡ä»¤é›†ä¸å¯„å­˜å™¨

RISC-V æ­£åœ¨æ”¹å˜èŠ¯ç‰‡è®¾è®¡çš„æ ¼å±€ã€‚ä½œä¸ºä¸€ç§å¼€æºæŒ‡ä»¤é›†æ¶æ„ï¼Œå®ƒç®€æ´è€Œå¼ºå¤§ã€‚

## ä»€ä¹ˆæ˜¯ RISC-Vï¼Ÿ

RISC-Vï¼ˆè¯»ä½œ"risk-five"ï¼‰æ˜¯ä¸€ä¸ªåŸºäºç²¾ç®€æŒ‡ä»¤é›†ï¼ˆRISCï¼‰åŸåˆ™çš„å¼€æºæŒ‡ä»¤é›†æ¶æ„ï¼ˆISAï¼‰ã€‚

### ä¸ºä»€ä¹ˆé€‰æ‹© RISC-Vï¼Ÿ

- ğŸ”“ **å¼€æºå…è´¹** - æ— éœ€æ”¯ä»˜æˆæƒè´¹ç”¨
- ğŸ“š **ç®€æ´è®¾è®¡** - æ˜“äºå­¦ä¹ å’Œå®ç°
- ğŸ”§ **æ¨¡å—åŒ–** - æ”¯æŒå¯é€‰æ‰©å±•
- ğŸš€ **ç°ä»£åŒ–** - ä»é›¶å¼€å§‹è®¾è®¡ï¼Œé¿å…äº†å†å²åŒ…è¢±

## å¯„å­˜å™¨çº¦å®š

### é€šç”¨å¯„å­˜å™¨

RISC-V æœ‰ 32 ä¸ªé€šç”¨å¯„å­˜å™¨ï¼ˆRV32/RV64ï¼‰ï¼š

| å¯„å­˜å™¨ | ABI åç§° | æè¿° | Caller/Callee |
|--------|----------|------|---------------|
| x0 | zero | ç¡¬è¿çº¿é›¶ | - |
| x1 | ra | è¿”å›åœ°å€ | Caller |
| x2 | sp | æ ˆæŒ‡é’ˆ | Callee |
| x3 | gp | å…¨å±€æŒ‡é’ˆ | - |
| x4 | tp | çº¿ç¨‹æŒ‡é’ˆ | - |
| x5-x7 | t0-t2 | ä¸´æ—¶å¯„å­˜å™¨ | Caller |
| x8 | s0/fp | ä¿å­˜å¯„å­˜å™¨/å¸§æŒ‡é’ˆ | Callee |
| x9 | s1 | ä¿å­˜å¯„å­˜å™¨ | Callee |
| x10-x11 | a0-a1 | å‡½æ•°å‚æ•°/è¿”å›å€¼ | Caller |
| x12-x17 | a2-a7 | å‡½æ•°å‚æ•° | Caller |
| x18-x27 | s2-s11 | ä¿å­˜å¯„å­˜å™¨ | Callee |
| x28-x31 | t3-t6 | ä¸´æ—¶å¯„å­˜å™¨ | Caller |

### å…³é”®å¯„å­˜å™¨è¯´æ˜

**é›¶å¯„å­˜å™¨ï¼ˆx0/zeroï¼‰**
```assembly
addi x5, x0, 10     # x5 = 0 + 10 = 10
add x6, x0, x0      # x6 = 0ï¼ˆæ¸…é›¶æ“ä½œï¼‰
```

**è¿”å›åœ°å€ï¼ˆx1/raï¼‰**
```assembly
jal ra, function    # è°ƒç”¨å‡½æ•°ï¼Œè¿”å›åœ°å€ä¿å­˜åˆ° ra
jalr x0, ra, 0      # è¿”å›ï¼ˆç­‰ä»·äº retï¼‰
```

**æ ˆæŒ‡é’ˆï¼ˆx2/spï¼‰**
```assembly
addi sp, sp, -16    # åˆ†é…æ ˆç©ºé—´
sw ra, 12(sp)       # ä¿å­˜è¿”å›åœ°å€
```

## åŸºæœ¬æŒ‡ä»¤

### ç®—æœ¯æŒ‡ä»¤

```assembly
# ç«‹å³æ•°åŠ æ³•
addi x5, x6, 100    # x5 = x6 + 100

# å¯„å­˜å™¨åŠ æ³•
add x5, x6, x7      # x5 = x6 + x7

# å‡æ³•
sub x5, x6, x7      # x5 = x6 - x7

# ä¹˜æ³•ï¼ˆéœ€è¦ M æ‰©å±•ï¼‰
mul x5, x6, x7      # x5 = x6 * x7
```

### é€»è¾‘æŒ‡ä»¤

```assembly
# ä¸æ“ä½œ
and x5, x6, x7      # x5 = x6 & x7
andi x5, x6, 0xFF   # x5 = x6 & 0xFF

# æˆ–æ“ä½œ
or x5, x6, x7       # x5 = x6 | x7

# å¼‚æˆ–
xor x5, x6, x7      # x5 = x6 ^ x7

# ç§»ä½
slli x5, x6, 3      # x5 = x6 << 3ï¼ˆé€»è¾‘å·¦ç§»ï¼‰
srli x5, x6, 2      # x5 = x6 >> 2ï¼ˆé€»è¾‘å³ç§»ï¼‰
```

### å†…å­˜è®¿é—®

```assembly
# åŠ è½½å­—ï¼ˆload wordï¼‰
lw x5, 0(x6)        # x5 = Memory[x6 + 0]

# å­˜å‚¨å­—ï¼ˆstore wordï¼‰
sw x5, 4(x6)        # Memory[x6 + 4] = x5

# åŠ è½½å­—èŠ‚
lb x5, 0(x6)        # åŠ è½½å­—èŠ‚ï¼ˆç¬¦å·æ‰©å±•ï¼‰
lbu x5, 0(x6)       # åŠ è½½å­—èŠ‚ï¼ˆé›¶æ‰©å±•ï¼‰
```

### æ§åˆ¶æµ

```assembly
# æ— æ¡ä»¶è·³è½¬
j label             # è·³è½¬åˆ° label
jal ra, function    # è·³è½¬å¹¶é“¾æ¥ï¼ˆå‡½æ•°è°ƒç”¨ï¼‰

# æ¡ä»¶åˆ†æ”¯
beq x5, x6, label   # å¦‚æœ x5 == x6 åˆ™è·³è½¬
bne x5, x6, label   # å¦‚æœ x5 != x6 åˆ™è·³è½¬
blt x5, x6, label   # å¦‚æœ x5 < x6 åˆ™è·³è½¬ï¼ˆæœ‰ç¬¦å·ï¼‰
bge x5, x6, label   # å¦‚æœ x5 >= x6 åˆ™è·³è½¬ï¼ˆæœ‰ç¬¦å·ï¼‰
```

## å®æˆ˜ç¤ºä¾‹

### æ±‚å’Œå‡½æ•°

```assembly
# int sum(int a, int b) { return a + b; }
sum:
    add a0, a0, a1  # a0 = a0 + a1
    ret             # è¿”å›

# è°ƒç”¨
li a0, 5            # a0 = 5
li a1, 3            # a1 = 3
jal ra, sum         # è°ƒç”¨ sumï¼Œç»“æœåœ¨ a0 ä¸­
```

### æ•°ç»„æ±‚å’Œ

```assembly
# int array_sum(int *arr, int len)
array_sum:
    li t0, 0            # sum = 0
    li t1, 0            # i = 0
loop:
    bge t1, a1, done    # if i >= len, goto done
    
    lw t2, 0(a0)        # t2 = arr[i]
    add t0, t0, t2      # sum += t2
    
    addi a0, a0, 4      # arr++
    addi t1, t1, 1      # i++
    j loop
    
done:
    mv a0, t0           # return sum
    ret
```

### æ–æ³¢é‚£å¥‘æ•°åˆ—

```assembly
# int fib(int n)
fib:
    # ä¿å­˜å¯„å­˜å™¨
    addi sp, sp, -16
    sw ra, 12(sp)
    sw s0, 8(sp)
    
    # base case: n < 2
    li t0, 2
    blt a0, t0, base_case
    
    # é€’å½’: fib(n-1)
    addi s0, a0, 0      # ä¿å­˜ n
    addi a0, a0, -1
    jal ra, fib
    addi s1, a0, 0      # ä¿å­˜ fib(n-1)
    
    # é€’å½’: fib(n-2)
    addi a0, s0, -2
    jal ra, fib
    
    # è¿”å› fib(n-1) + fib(n-2)
    add a0, a0, s1
    j restore
    
base_case:
    # return n
    
restore:
    lw ra, 12(sp)
    lw s0, 8(sp)
    addi sp, sp, 16
    ret
```

## RISC-V æ‰©å±•

### æ ‡å‡†æ‰©å±•

- **I** - åŸºç¡€æ•´æ•°æŒ‡ä»¤é›†ï¼ˆå¿…éœ€ï¼‰
- **M** - æ•´æ•°ä¹˜é™¤æ³•
- **A** - åŸå­æ“ä½œ
- **F** - å•ç²¾åº¦æµ®ç‚¹
- **D** - åŒç²¾åº¦æµ®ç‚¹
- **C** - å‹ç¼©æŒ‡ä»¤ï¼ˆ16ä½ï¼‰

### ç»„åˆå‘½å

- **RV32I** - 32ä½åŸºç¡€æ•´æ•°
- **RV64G** - 64ä½é€šç”¨ï¼ˆI + M + A + F + Dï¼‰
- **RV32IMC** - 32ä½æ•´æ•° + ä¹˜é™¤ + å‹ç¼©

## å­¦ä¹ èµ„æº

- ğŸ“– [RISC-V è§„èŒƒ](https://riscv.org/technical/specifications/)
- ğŸ”§ [RISC-V æ¨¡æ‹Ÿå™¨](https://github.com/riscv/riscv-isa-sim)
- ğŸ“ [RISC-V åœ¨çº¿è¯¾ç¨‹](https://riscv.org/education/)
- ğŸ’» [RISC-V å·¥å…·é“¾](https://github.com/riscv-collab/riscv-gnu-toolchain)

## æ€»ç»“

RISC-V çš„ä¼˜åŠ¿ï¼š

- âœ… å¼€æºè‡ªç”±ï¼Œæ— ä¸“åˆ©æŸç¼š
- âœ… è®¾è®¡ç®€æ´ï¼Œæ˜“äºå­¦ä¹ 
- âœ… æ¨¡å—åŒ–æ‰©å±•ï¼Œçµæ´»å¼ºå¤§
- âœ… ç¤¾åŒºæ´»è·ƒï¼Œç”Ÿæ€ç¹è£

RISC-V æ˜¯æœªæ¥å¤„ç†å™¨æ¶æ„çš„é‡è¦æ–¹å‘ï¼ğŸš€
